!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.IframeChannel=t():e.IframeChannel=t()}(window,function(){return n={},e.m=t=[function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(t),n.d(t,"default",function(){return o});var s,a,o=(s=u,(a=[{key:"_handleQueue",value:function(){var e=this;this._queue.forEach(function(t){var n=t.message,r=t.msgChan;e._target.postMessage(n,e._targetOrigin,[r.port2])}),this._queue=[]}},{key:"_publish",value:function(e){var t=e.data.type;(this._subscribers[t]||[]).forEach(function(t){return t(e.data,e)})}},{key:"subscribe",value:function(e,t){if(e&&"function"==typeof t){this._subscribers[e]||(this._subscribers[e]=[]);var n=this._subscribers[e];if(n.includes(t)||n.push(t),"connect"===e&&this._isTargetReady){var r={source:this._target};t(r.data,r)}}}},{key:"unsubscribe",value:function(e,t){if(void 0!==e){var n=this._subscribers[e]||[];if(void 0!==t){var r=n.indexOf(t);-1<r&&n.splice(r,1)}else this._subscribers[e]=[]}else this._subscribers={}}},{key:"postMessage",value:function(e,t,n){var r=this;return new Promise(function(i,s){n=n||"".concat(e,"-").concat(Date.now());var a=new MessageChannel;a.port1.onmessage=function(e){var t=e.data,n=t.data,r=t.error;r?s(r):i(n)};var o={type:e,id:n,data:t};r._isTargetReady||"connect"===e?r._target.postMessage(o,r._targetOrigin,[a.port2]):r._queue.push({id:n,message:o,msgChan:a})})}},{key:"connect",value:function(){var e=this;return this._target?this._isTargetReady?Promise.resolve("Target has already connected."):this.postMessage("connect").then(function(t){e._isTargetReady=!0,e._handleQueue()}).catch(function(t){console.log(t),e._isTargetReady=!1}):Promise.reject(new Error("Target not exsist."))}},{key:"clearQueue",value:function(){this._queue=[]}},{key:"destory",value:function(){this._subscribers={},this._targetOrigin="",this._target=void 0,this._queue=[],this._isTargetReady=!1,window.removeEventListener("message",this._handleMessage)}}])&&r(s.prototype,a),u);function u(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof u))throw new TypeError("Cannot call a class as a function")}(this),i(this,"_handleMessage",function(t){t.origin===e._targetOrigin&&e._publish(t)}),i(this,"_handleConnect",function(t,n){var r=t.type,i=n.source;e._target&&e._target!==i?n.ports[0].postMessage({type:r,error:"Connection is rejected."}):(n.ports[0].postMessage({type:r,data:"Connection is accepted."}),e._target=i,e._isTargetReady=!0,e._handleQueue())});var n=t.targetOrigin,r=void 0===n?"":n,s=t.subscribers,a=void 0===s?{}:s,o=t.target;if(o===window)throw new Error("The target can not be current window.");this._subscribers=a,this._targetOrigin=r,this._target=o,this._queue=[],this._isTargetReady=!1,this.subscribe("connect",this._handleConnect),window.addEventListener("message",this._handleMessage,!1),window.addEventListener("unload",function(){e.destory()})}}],e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:r})},e.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var i in t)e.d(r,i,function(e){return t[e]}.bind(null,i));return r},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.p="",e(e.s=0);function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var t,n});